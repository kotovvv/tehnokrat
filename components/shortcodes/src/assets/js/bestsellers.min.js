/* global jQuery, tehnokrat_script, bestsellers */

jQuery(document).ready(function ($) {
    window.addEventListener('scroll', maybePushImpressions);

    let slick = $(".top-slider").slick({
        dots: !1,
        arrows: !0,
        infinite: !0,
        prevArrow: tehnokrat_script['slickPrevArrow'],
        nextArrow: tehnokrat_script['slickNextArrow'],
        speed: 300,
        slidesToShow: 4,
        slidesToScroll: 1,
        responsive: [{
            breakpoint: 1020,
            settings: {
                slidesToShow: 3,
                slidesToScroll: 1,
                arrows: !0
            }
        }, {
            breakpoint: 600,
            settings: {
                slidesToShow: 2,
                slidesToScroll: 1,
                arrows: !0
            }
        }, {
            breakpoint: 500,
            settings: {
                slidesToShow: 1,
                slidesToScroll: 1,
                arrows: !0
            }
        }]
    });
    slick.on('afterChange', maybePushImpressions);
    $(".top-slider .slick-slide .name").matchHeight({
        byRow: !1
    });
    $(".top-slider .slick-slide .for-img").matchHeight({
        byRow: !1
    });
    $("a.bb-byu", ".top-slider").on("click", function () {
        let slidesToShow = slick[0].slick.slickGetOption('slidesToShow');
        let index = $(this).parents(".slick-active").data('slick-index') % (slidesToShow + 1);

        dataLayer.push({
            'ecommerce': {
                'currencyCode': 'UAH',
                'click': {
                    'actionField': {'list': 'recommended'},
                    'products': [{
                        "id": bestsellers[index]['id'],
                        "name": bestsellers[index]['title'],
                        "price": bestsellers[index]['price_uah'],
                        "list": 'recommended',
                        "position": index + 1,
                    }]
                }
            },
            'event': 'gtm-ee-event',
            'gtm-ee-event-category': 'Enhanced Ecommerce',
            'gtm-ee-event-action': 'Product Clicks',
            'gtm-ee-event-non-interaction': 'False',
        });
    });

    function maybePushImpressions() {
        if (!isSliderVisible()) {
            return;
        }

        let slidesToShow = slick[0].slick.slickGetOption('slidesToShow');
        $('.slick-active', slick[0]).each(function () {
            let index = $(this).data('slick-index') % (slidesToShow + 1);

            if ('pushed' in bestsellers[index]) {
                // данные о показе уже переданы
            } else {
                bestsellers[index].pushed = true;

                window.dataLayer.push({
                    "ecommerce": {
                        "currencyCode": "UAH",
                        "impressions": [{
                            "id": bestsellers[index]['id'],
                            "name": bestsellers[index]['title'],
                            "price": bestsellers[index]['price_uah'],
                            "list": 'recommended',
                            "position": index + 1,
                        }]
                    }
                });
            }
        });
    }

    function isSliderVisible() {
        const rect = slick[0].getBoundingClientRect();

        // слайдер считается видимым если он появился на 1/2 высоты
        return (
            rect.top >= 0 &&
            rect.left >= 0 &&
            rect.bottom <= (rect.bottom - rect.top) / 2 + (window.innerHeight || document.documentElement.clientHeight) &&
            rect.right <= (window.innerWidth || document.documentElement.clientWidth)
        );
    }

    maybePushImpressions();
});
